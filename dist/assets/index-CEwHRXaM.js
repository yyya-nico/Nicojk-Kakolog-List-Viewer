(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const u of document.querySelectorAll('link[rel="modulepreload"]'))g(u);new MutationObserver(u=>{for(const d of u)if(d.type==="childList")for(const M of d.addedNodes)M.tagName==="LINK"&&M.rel==="modulepreload"&&g(M)}).observe(document,{childList:!0,subtree:!0});function h(u){const d={};return u.integrity&&(d.integrity=u.integrity),u.referrerPolicy&&(d.referrerPolicy=u.referrerPolicy),u.crossOrigin==="use-credentials"?d.credentials="include":u.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function g(u){if(u.ep)return;u.ep=!0;const d=h(u);fetch(u.href,d)}})();const j=E=>typeof E!="string"?E:E.replace(/[&'`"<>]/g,e=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[e]);document.addEventListener("DOMContentLoaded",()=>{const E=document.querySelector("header"),e=document.forms["jk-load"];e.channelPicker=e.elements["channel-picker"],e.datetimeField=e.querySelector(".datetime-field"),e._date=e.elements.date,e.timeStart=e.elements["time-start"],e.timeEnd=e.elements["time-end"],e.dateTimeButtons=e.querySelector(".datetime-buttons"),e.dateButtons=e.querySelector(".date-buttons"),e.dateMinus1D=e.elements["date--1d"],e.dateMinus2D=e.elements["date--2d"],e.dateMinus5D=e.elements["date--5d"],e.dateMinus7D=e.elements["date--7d"],e.dateMinus14D=e.elements["date--14d"],e.dateMinus1M=e.elements["date--1m"],e.dateMinus3M=e.elements["date--3m"],e.dateMinus6M=e.elements["date--6m"],e.dateMinus1Y=e.elements["date--1y"],e.dateMinus5Y=e.elements["date--5y"],e.timeButtons=e.querySelector(".time-buttons"),e.timePlus1H=e.elements["time-+1h"],e.timePlus2H=e.elements["time-+2h"],e.timePlus6H=e.elements["time-+6h"],e.timePlus12H=e.elements["time-+12h"],e.timePlus1M=e.elements["time-+1m"],e.timePlus2M=e.elements["time-+2m"],e.timePlus5M=e.elements["time-+5m"],e.timePlus10M=e.elements["time-+10m"],e.timePlus30M=e.elements["time-+30m"],e.resetButton=e.elements["reset-button"],e.submitButton=e.elements["submit-button"];const h=document.getElementById("comments-list"),g=document.querySelector(".detail-pc"),u=()=>window.innerWidth<1024,d=new Date,M=new Date(d);M.setMinutes(d.getMinutes()-1);const C=("0"+d.getDate()).slice(-2),_=("0"+(d.getMonth()+1)).slice(-2),k=d.getFullYear()+"-"+_+"-"+C,L=d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),w=M.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),$=document.title;e._date.value=k,e._date.max=k,e.timeStart.max=w,e.timeEnd.max=L;const H=()=>{if(location.search){const t=new URLSearchParams(location.search),n=a=>{if(!t.has(a))return!1;const i=t.get(a);switch(a){case"ch":return[...e.channelPicker.options].some(o=>o.value===i);case"date":const r=e._date;return i>=r.min&&i<=r.max;case"timestart":case"timeend":return i>="00:00"&&i<="23:59";default:return!1}};["ch","date","timestart","timeend"].every(a=>n(a))?(e.channelPicker.value=t.get("ch"),e._date.value=t.get("date"),e.timeStart.value=t.get("timestart"),e.timeEnd.disabled=!1,e.timeEnd.value=t.get("timeend"),e.resetButton.hidden=!1,e.submitButton.disabled=!1,T(),e.requestSubmit()):alert("過去ログの指定が不正でした。")}},x=()=>e.submitButton.disabled=!e.checkValidity();e.datetimeField.addEventListener("change",x),e.datetimeField.addEventListener("click",x);let P=!1;const A=()=>{e._date.value!==""&&e.timeStart.value!==""&&(e.timeEnd.disabled=!1,P||(e.timeEnd.value=e.timeStart.value)),e.resetButton.hidden=!1};[e._date,e.timeStart].forEach(t=>{t.addEventListener("input",A)});const T=()=>{if(e.timeStart.value===""||e.timeEnd.value==="")return;const t=e.timeStart.valueAsDate;t.setMinutes(t.getMinutes()+1);const n=t.toLocaleTimeString([],{timeZone:"UTC",hour:"2-digit",minute:"2-digit"}),a=e._date.valueAsDate.getDate()===d.getDate()-1,i=e.timeStart.value>=L,p=e.timeStart.value>=e.timeEnd.value,r=(o,l,s)=>{o[l]!==s&&(o[l]=s)};e._date.value===k?(r(e.timeStart,"max",w),r(e.timeEnd,"min",n),r(e.timeEnd,"max",L)):a&&i&&p?(r(e.timeStart,"max",""),r(e.timeEnd,"min",""),r(e.timeEnd,"max",L)):(r(e.timeStart,"max",""),r(e.timeEnd,"min",""),r(e.timeEnd,"max",""))};let f=null;[e._date,e.timeStart,e.timeEnd].forEach(t=>{t.addEventListener("focus",n=>{switch(f=n.target,f.value===""&&(f.value="00:00",f.dispatchEvent(new Event("input",{bubbles:!0})),f.dispatchEvent(new Event("change",{bubbles:!0}))),e.dateTimeButtons.hidden=!1,f){case e._date:e.dateButtons.hidden=!1,e.timeButtons.hidden=!0;break;case e.timeStart:case e.timeEnd:e.dateButtons.hidden=!0,e.timeButtons.hidden=!1;break}}),t.addEventListener("click",n=>n.preventDefault(),{once:!0}),t.addEventListener("input",T),t.addEventListener("blur",()=>{t.addEventListener("click",n=>n.preventDefault(),{once:!0})})}),e.timeEnd.addEventListener("input",()=>P=!0),document.addEventListener("click",t=>{t.target.closest(".jk-load-form")||(e.dateTimeButtons.hidden=!0,e.dateButtons.hidden=!0,e.timeButtons.hidden=!0)}),[e.dateMinus1D,e.dateMinus2D,e.dateMinus5D,e.dateMinus7D,e.dateMinus14D,e.dateMinus1M,e.dateMinus3M,e.dateMinus6M,e.dateMinus1Y,e.dateMinus5Y,e.timePlus1H,e.timePlus2H,e.timePlus6H,e.timePlus12H,e.timePlus1M,e.timePlus2M,e.timePlus5M,e.timePlus10M,e.timePlus30M].forEach(t=>{t.addEventListener("click",n=>{const a=f.valueAsDate,i=s=>a.setDate(a.getDate()+s),p=s=>a.setMonth(a.getMonth()+s),r=s=>a.setFullYear(a.getFullYear()+s),o=s=>a.setHours(a.getHours()+s),l=s=>a.setMinutes(a.getMinutes()+s);switch(n.target){case e.dateMinus1D:i(-1);break;case e.dateMinus2D:i(-2);break;case e.dateMinus5D:i(-5);break;case e.dateMinus7D:i(-7);break;case e.dateMinus14D:i(-14);break;case e.dateMinus1M:p(-1);break;case e.dateMinus3M:p(-3);break;case e.dateMinus6M:p(-6);break;case e.dateMinus1Y:r(-1);break;case e.dateMinus5Y:r(-5);break;case e.timePlus1H:o(1);break;case e.timePlus2H:o(2);break;case e.timePlus6H:o(6);break;case e.timePlus12H:o(12);break;case e.timePlus1M:l(1);break;case e.timePlus2M:l(2);break;case e.timePlus5M:l(5);break;case e.timePlus10M:l(10);break;case e.timePlus30M:l(30);break}f.valueAsDate=a,f.dispatchEvent(new Event("input",{bubbles:!0})),f.dispatchEvent(new Event("change",{bubbles:!0}))})});const U=t=>{t=t.chat;const n={text:j(t.content).replace(/\n/g,"<br>"),time:new Date(Number(t.date)*1e3).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"})};return`<li data-thread="${t.thread}" data-no="${t.no}" data-user-id="${t.user_id}" tabindex="0">
      <span class="text">${n.text}</span><span class="time">${n.time}</span>
      <script type="application/json" class="raw-data">${JSON.stringify(t)}<\/script>
    </li>
    `},O=t=>{let n="";for(;t.length;)n+=U(t.shift());h.insertAdjacentHTML("beforeend",n)};e.addEventListener("submit",async t=>{t.preventDefault(),e.submitButton.disabled=!0,e.submitButton.textContent="読み込み中...",h.textContent="";const n=new URL(`https://jikkyo.tsukumijima.net/api/kakolog/${e.channelPicker.value}`),a=n.searchParams,i=s=>Math.floor(new Date(s).getTime()/1e3),p=i(`${e._date.value}T${e.timeStart.value}`);a.append("starttime",p);const r=new Date(`${e._date.value}T${e.timeEnd.value}`),o=e.timeStart.valueAsDate<e.timeEnd.valueAsDate?i(r):(()=>{const s=r.setDate(r.getDate()+1);return i(s)})();a.append("endtime",o),a.append("format","json"),await fetch(n).then(async s=>{const v=await s.json();s.status===200?v.error?(console.error("Error:",v.error),alert("エラー:"+v.error)):v.packet.length?O(v.packet):(console.log("not comments found"),alert("指定の期間にコメントがありませんでした。")):console.log("error or no content",s.status)}).catch(s=>{console.error("Failed to load",s)}),document.title=`${$} - ${e.channelPicker.selectedOptions[0].label} ${e._date.value.replaceAll("-","/")} ${e.timeStart.value} - ${e.timeEnd.value}`;const l=new URLSearchParams(location.search);l.set("ch",e.channelPicker.value),l.set("date",e._date.value),l.set("timestart",e.timeStart.value),l.set("timeend",e.timeEnd.value),history.pushState(null,"",`${location.pathname}?${l.toString()}`),e.submitButton.disabled=!1,e.submitButton.textContent="取得"},{passive:!1}),H(),e.addEventListener("reset",t=>{t.preventDefault(),e._date.value=k,e.timeStart.value="",e.timeEnd.value="",e.timeEnd.disabled=!0,e.dateTimeButtons.hidden=!0,e.dateButtons.hidden=!0,e.timeButtons.hidden=!0,e.resetButton.hidden=!0,e.submitButton.disabled=!0,P=!1},{passive:!1}),h.addEventListener("click",t=>{const n=t.target.closest("li"),a=document.querySelector(".detail-sp"),i=document.getElementsByClassName("same-user");if(!n||n.classList.contains("detail-sp"))return;if([...i].forEach(m=>m.classList.remove("same-user")),n.nextElementSibling&&n.nextElementSibling.classList.contains("detail-sp")){g.textContent="",a.remove();return}g.textContent!==""&&(g.textContent=""),a&&a.remove();const p=u()?n.offsetTop-2-10:n.offsetTop-(window.innerHeight-E.offsetHeight-n.offsetHeight)/2,r=t.isTrusted?"smooth":"instant";window.scrollTo({top:p,behavior:r});const o=JSON.parse(n.querySelector(".raw-data").textContent),l=document.createElement("dl"),s={thread:"スレッドID",no:"コメント番号",vpos:"再生時間",date:"日時",date_usec:"日時(小数部)",user_id:"ユーザーID",name:"ニックネーム",mail:"コマンド",premium:"プレミアム会員",anonymity:"匿名",content:"コメント"};let v="";Object.keys(o).forEach(m=>{let c=o[m];switch(m){case"vpos":const S=new Date(Number(c)*10);S.getUTCDate()-1?(S.setUTCMonth(S.getUTCDate()-2),c=S.toLocaleString([],{timeZone:"UTC",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2})):c=S.toLocaleString([],{timeZone:"UTC",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2});break;case"date":c=new Date(Number(c)*1e3).toLocaleString([],{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});break;case"date_usec":c="0."+c;break;case"user_id":case"name":!o.anonymity&&(c=`<a href="https://nico.ms/user/${o.user_id}" target="_blank">${c}</a>`);break;case"premium":c==="3"&&(c="(2ch実況板からの転載)");case"anonymity":switch(c){case"0":c="いいえ";break;case"1":c="はい";break}break}v+=`<dt>${s[m]||m}</dt>
      <dd>${c}</dd>
      `}),l.innerHTML=v;const y=[...h.children].filter(m=>m.dataset.userId===o.user_id),B=`<dl>
      <dt>コメント回数</dt>
      <dd>${y.findIndex(m=>m.dataset.thread===o.thread&&m.dataset.no===o.no)+1}回目/全${y.length}回中</dd>
    </dl>
    `;g.appendChild(l.cloneNode(!0)),g.appendChild(document.createElement("hr")),g.insertAdjacentHTML("beforeend",B);const D=document.createElement("li");D.classList.add("detail-sp"),D.appendChild(l),D.appendChild(document.createElement("hr")),D.insertAdjacentHTML("beforeend",B),n.insertAdjacentElement("afterend",D),y.forEach(m=>m.classList.add("same-user"))});let b=null;h.addEventListener("focus",t=>{b=t.target},!0),h.addEventListener("keydown",t=>{switch(console.log(t.key),t.key){case"ArrowUp":t.preventDefault(),(()=>{const n=b?b.previousElementSibling??h.lastElementChild:h.firstElementChild;n.click(),n.focus()})();break;case"ArrowDown":t.preventDefault(),(()=>{var a,i;const n=((a=b==null?void 0:b.nextElementSibling)!=null&&a.classList.contains("detail-sp")?(i=b.nextElementSibling)==null?void 0:i.nextElementSibling:b==null?void 0:b.nextElementSibling)??h.firstElementChild;n.click(),n.focus()})();break;case" ":case"Enter":t.target===document.activeElement&&(t.preventDefault(),t.target.click(),t.target.focus());break}})});
