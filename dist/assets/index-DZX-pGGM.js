(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))p(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const M of r.addedNodes)M.tagName==="LINK"&&M.rel==="modulepreload"&&p(M)}).observe(document,{childList:!0,subtree:!0});function g(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function p(o){if(o.ep)return;o.ep=!0;const r=g(o);fetch(o.href,r)}})();const U=b=>typeof b!="string"?b:b.replace(/[&'`"<>]/g,e=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[e]);document.addEventListener("DOMContentLoaded",()=>{const b=document.querySelector("header"),e=document.forms["jk-load"];e.channelPicker=e.elements["channel-picker"],e.datetimeField=e.querySelector(".datetime-field"),e._date=e.elements.date,e.timeStart=e.elements["time-start"],e.timeEnd=e.elements["time-end"],e.dateTimeButtons=e.querySelector(".datetime-buttons"),e.dateButtons=e.querySelector(".date-buttons"),e.dateMinus1D=e.elements["date--1d"],e.dateMinus2D=e.elements["date--2d"],e.dateMinus5D=e.elements["date--5d"],e.dateMinus7D=e.elements["date--7d"],e.dateMinus14D=e.elements["date--14d"],e.dateMinus1M=e.elements["date--1m"],e.dateMinus3M=e.elements["date--3m"],e.dateMinus6M=e.elements["date--6m"],e.dateMinus1Y=e.elements["date--1y"],e.dateMinus5Y=e.elements["date--5y"],e.timeButtons=e.querySelector(".time-buttons"),e.timePlus1H=e.elements["time-+1h"],e.timePlus2H=e.elements["time-+2h"],e.timePlus6H=e.elements["time-+6h"],e.timePlus12H=e.elements["time-+12h"],e.timePlus1M=e.elements["time-+1m"],e.timePlus2M=e.elements["time-+2m"],e.timePlus5M=e.elements["time-+5m"],e.timePlus10M=e.elements["time-+10m"],e.timePlus30M=e.elements["time-+30m"],e.resetButton=e.elements["reset-button"],e.submitButton=e.elements["submit-button"];const g=document.getElementById("comments-list"),p=document.querySelector(".detail-pc"),o=()=>window.innerWidth<1024,r=new Date,M=new Date(r);M.setMinutes(r.getMinutes()-1);const x=("0"+r.getDate()).slice(-2),C=("0"+(r.getMonth()+1)).slice(-2),S=r.getFullYear()+"-"+C+"-"+x,L=r.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),y=M.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),_=document.title;e._date.value=S,e._date.max=S,e.timeStart.max=y,e.timeEnd.max=L;const $=()=>{if(location.search){const t=new URLSearchParams(location.search),n=a=>{if(!t.has(a))return!1;const d=t.get(a);switch(a){case"ch":return[...e.channelPicker.options].some(u=>u.value===d);case"date":const s=e._date;return d>=s.min&&d<=s.max;case"timestart":case"timeend":return d>="00:00"&&d<="23:59";default:return!1}};["ch","date","timestart","timeend"].every(a=>n(a))?(e.channelPicker.value=t.get("ch"),e._date.value=t.get("date"),e.timeStart.value=t.get("timestart"),e.timeEnd.disabled=!1,e.timeEnd.value=t.get("timeend"),e.resetButton.hidden=!1,e.submitButton.disabled=!1,T(),e.requestSubmit()):alert("過去ログの指定が不正でした。")}},w=()=>e.submitButton.disabled=!e.checkValidity();e.datetimeField.addEventListener("change",w),e.datetimeField.addEventListener("click",w);let k=!1;const H=()=>{e._date.value!==""&&e.timeStart.value!==""&&(e.timeEnd.disabled=!1,k||(e.timeEnd.value=e.timeStart.value)),e.resetButton.hidden=!1};[e._date,e.timeStart].forEach(t=>{t.addEventListener("input",H)});const T=()=>{if(e.timeStart.value===""||e.timeEnd.value==="")return;const t=e.timeStart.valueAsDate;t.setMinutes(t.getMinutes()+1);const n=t.toLocaleTimeString([],{timeZone:"UTC",hour:"2-digit",minute:"2-digit"}),a=e._date.valueAsDate.getDate()===r.getDate()-1,d=e.timeStart.value>=L,f=e.timeStart.value>=e.timeEnd.value,s=(u,l,i)=>{u[l]!==i&&(u[l]=i)};e._date.value===S?(s(e.timeStart,"max",y),s(e.timeEnd,"min",n),s(e.timeEnd,"max",L)):a&&d&&f?(s(e.timeStart,"max",""),s(e.timeEnd,"min",""),s(e.timeEnd,"max",L)):(s(e.timeStart,"max",""),s(e.timeEnd,"min",""),s(e.timeEnd,"max",""))};let h=null;[e._date,e.timeStart,e.timeEnd].forEach(t=>{t.addEventListener("focus",n=>{switch(h=n.target,h.value===""&&(h.value="00:00",h.dispatchEvent(new Event("input",{bubbles:!0})),h.dispatchEvent(new Event("change",{bubbles:!0}))),e.dateTimeButtons.hidden=!1,h){case e._date:e.dateButtons.hidden=!1,e.timeButtons.hidden=!0;break;case e.timeStart:case e.timeEnd:e.dateButtons.hidden=!0,e.timeButtons.hidden=!1;break}}),t.addEventListener("click",n=>n.preventDefault(),{once:!0}),t.addEventListener("input",T),t.addEventListener("blur",()=>{t.addEventListener("click",n=>n.preventDefault(),{once:!0})})}),e.timeEnd.addEventListener("input",()=>k=!0),document.addEventListener("click",t=>{t.target.closest(".jk-load-form")||(e.dateTimeButtons.hidden=!0,e.dateButtons.hidden=!0,e.timeButtons.hidden=!0)}),[e.dateMinus1D,e.dateMinus2D,e.dateMinus5D,e.dateMinus7D,e.dateMinus14D,e.dateMinus1M,e.dateMinus3M,e.dateMinus6M,e.dateMinus1Y,e.dateMinus5Y,e.timePlus1H,e.timePlus2H,e.timePlus6H,e.timePlus12H,e.timePlus1M,e.timePlus2M,e.timePlus5M,e.timePlus10M,e.timePlus30M].forEach(t=>{t.addEventListener("click",n=>{const a=h.valueAsDate,d=i=>a.setDate(a.getDate()+i),f=i=>a.setMonth(a.getMonth()+i),s=i=>a.setFullYear(a.getFullYear()+i),u=i=>a.setHours(a.getHours()+i),l=i=>a.setMinutes(a.getMinutes()+i);switch(n.target){case e.dateMinus1D:d(-1);break;case e.dateMinus2D:d(-2);break;case e.dateMinus5D:d(-5);break;case e.dateMinus7D:d(-7);break;case e.dateMinus14D:d(-14);break;case e.dateMinus1M:f(-1);break;case e.dateMinus3M:f(-3);break;case e.dateMinus6M:f(-6);break;case e.dateMinus1Y:s(-1);break;case e.dateMinus5Y:s(-5);break;case e.timePlus1H:u(1);break;case e.timePlus2H:u(2);break;case e.timePlus6H:u(6);break;case e.timePlus12H:u(12);break;case e.timePlus1M:l(1);break;case e.timePlus2M:l(2);break;case e.timePlus5M:l(5);break;case e.timePlus10M:l(10);break;case e.timePlus30M:l(30);break}h.valueAsDate=a,h.dispatchEvent(new Event("input",{bubbles:!0})),h.dispatchEvent(new Event("change",{bubbles:!0}))})});const A=t=>{t=t.chat;const n={text:U(t.content).replace(/\n/g,"<br>"),time:new Date(Number(t.date)*1e3).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"})};return`<li data-thread="${t.thread}" data-no="${t.no}" data-user-id="${t.user_id}">
      <span class="text">${n.text}</span><span class="time">${n.time}</span>
      <script type="application/json" class="raw-data">${JSON.stringify(t)}<\/script>
    </li>
    `},O=t=>{let n="";for(;t.length;)n+=A(t.shift());g.insertAdjacentHTML("beforeend",n)};e.addEventListener("submit",async t=>{t.preventDefault(),e.submitButton.disabled=!0,e.submitButton.textContent="読み込み中...",g.textContent="";const n=new URL(`https://jikkyo.tsukumijima.net/api/kakolog/${e.channelPicker.value}`),a=n.searchParams,d=i=>Math.floor(new Date(i).getTime()/1e3),f=d(`${e._date.value}T${e.timeStart.value}`);a.append("starttime",f);const s=new Date(`${e._date.value}T${e.timeEnd.value}`),u=e.timeStart.valueAsDate<e.timeEnd.valueAsDate?d(s):(()=>{const i=s.setDate(s.getDate()+1);return d(i)})();a.append("endtime",u),a.append("format","json"),await fetch(n).then(async i=>{const v=await i.json();i.status===200?v.error?(console.error("Error:",v.error),alert("エラー:"+v.error)):v.packet.length?O(v.packet):(console.log("not comments found"),alert("指定の期間にコメントがありませんでした。")):console.log("error or no content",i.status)}).catch(i=>{console.error("Failed to load",i)}),document.title=`${_} - ${e.channelPicker.selectedOptions[0].label} ${e._date.value.replaceAll("-","/")} ${e.timeStart.value} - ${e.timeEnd.value}`;const l=new URLSearchParams(location.search);l.set("ch",e.channelPicker.value),l.set("date",e._date.value),l.set("timestart",e.timeStart.value),l.set("timeend",e.timeEnd.value),history.pushState(null,"",`${location.pathname}?${l.toString()}`),e.submitButton.disabled=!1,e.submitButton.textContent="取得"},{passive:!1}),$(),e.addEventListener("reset",t=>{t.preventDefault(),e._date.value=S,e.timeStart.value="",e.timeEnd.value="",e.timeEnd.disabled=!0,e.dateTimeButtons.hidden=!0,e.dateButtons.hidden=!0,e.timeButtons.hidden=!0,e.resetButton.hidden=!0,e.submitButton.disabled=!0,k=!1},{passive:!1}),g.addEventListener("click",t=>{const n=t.target.closest("li"),a=document.querySelector(".detail-sp"),d=document.getElementsByClassName("same-user");if(!n||n.classList.contains("detail-sp"))return;if([...d].forEach(m=>m.classList.remove("same-user")),n.nextElementSibling&&n.nextElementSibling.classList.contains("detail-sp")){p.textContent="",a.remove();return}p.textContent!==""&&(p.textContent=""),a&&a.remove();const f=o()?n.offsetTop-2-10:n.offsetTop-(window.innerHeight-b.offsetHeight-n.offsetHeight)/2;window.scrollTo({top:f});const s=JSON.parse(n.querySelector(".raw-data").textContent),u=document.createElement("dl"),l={thread:"スレッドID",no:"コメント番号",vpos:"再生時間",date:"日時",date_usec:"日時(小数部)",user_id:"ユーザーID",name:"ニックネーム",mail:"コマンド",premium:"プレミアム会員",anonymity:"匿名",content:"コメント"};let i="";Object.keys(s).forEach(m=>{let c=s[m];switch(m){case"vpos":const D=new Date(Number(c)*10);D.getUTCDate()-1?(D.setUTCMonth(D.getUTCDate()-2),c=D.toLocaleString([],{timeZone:"UTC",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2})):c=D.toLocaleString([],{timeZone:"UTC",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2});break;case"date":c=new Date(Number(c)*1e3).toLocaleString([],{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});break;case"date_usec":c="0."+c;break;case"user_id":case"name":!s.anonymity&&(c=`<a href="https://nico.ms/user/${s.user_id}" target="_blank">${c}</a>`);break;case"premium":c==="3"&&(c="(2ch実況板からの転載)");case"anonymity":switch(c){case"0":c="いいえ";break;case"1":c="はい";break}break}i+=`<dt>${l[m]||m}</dt>
      <dd>${c}</dd>
      `}),u.innerHTML=i;const P=[...g.children].filter(m=>m.dataset.userId===s.user_id),B=`<dl>
      <dt>コメント回数</dt>
      <dd>${P.findIndex(m=>m.dataset.thread===s.thread&&m.dataset.no===s.no)+1}回目/全${P.length}回中</dd>
    </dl>
    `;p.appendChild(u.cloneNode(!0)),p.appendChild(document.createElement("hr")),p.insertAdjacentHTML("beforeend",B);const E=document.createElement("li");E.classList.add("detail-sp"),E.appendChild(u),E.appendChild(document.createElement("hr")),E.insertAdjacentHTML("beforeend",B),n.insertAdjacentElement("afterend",E),P.forEach(m=>m.classList.add("same-user"))})});
